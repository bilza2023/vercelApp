<script>
// @ts-nocheck
import {BASE_URL,onMount,toast} from '$lib/util';
import MainNav from '$lib/appComp/MainNav.svelte';
// import MainPanel from './MainPanel.svelte';
import EqPanel from './EqPanel.svelte';
import Sticky from "./Sticky.svelte";
import { Howl } from 'howler';
import SidePanel from './sp/SidePanel.svelte';
import FullScreen from './sp/FullScreen.svelte';
////////////////////////////////////////////////

function updateTimeDiff() {
      runningTime = sound.seek();
      // setFocus();
      checkFullScreen();
    if (runningTime > (sound.duration() * 1000)) {
        stop();
    }
}
function checkFullScreen(){
 setCurrentEq();
  if (currentEq.fs.length > 0) {
     if (runningTime >= currentEq.fsStartTime && runningTime < currentEq.fsEndTime ){
      // console.log("Full screen data avaialbe");
      fullScreen = true;
     }else {
      fullScreen = false;
     }
  }
return false;  
}
function setCurrentEq(){
 for (let i = 0; i < eqs.length; i++) {
 const eq = eqs[i];
        if (runningTime >= eq.eqStartTime && runningTime < eq.eqEndTime ){
       currentEq = eq;
        return; 
        }
 }
}
function changeSeek(newSeekValue){
 sound.seek(newSeekValue);
 runningTime = sound.seek();
//  setFocus();
//  console.log('sound.seek',r);
}
 
function start(){
    // debugger;
    if (isPlaying == true){return;}
    isPlaying = true;
    sound.play();
        sound.on('play', function () {
        interval = setInterval(updateTimeDiff,1000);
        // runningTime = runningTime +0; 
        });
    
}

function stop(){
    sound.stop();
    isPlaying = false;
    runningTime = 0;
    clearInterval(interval);
    window.scrollTo({top: 0,behavior: 'smooth'});
    // setFocus();
}
function getIsfTrue() {
    for (let i = 0; i < eqs.length; i++) {
        if (eqs[i].isf === true) {
            return eqs[i];
        }
    }
    return null;
}

async function fileExists(url) {
  try {
    const response = await fetch(url);
    return response.status === 200;
  } catch (error) {
    return false;
  }
}

async function getSoundFile(filename) {
  const soundFile = `./mathSounds/${filename}.mp3`;
  
  if (await fileExists(soundFile)) {
    return soundFile;
  } else {
    return './mathSounds/test.mp3';
  }
}

//=======
/////////////////////////
let currentEq;
/////////////////////////
let soundFile;
let sound;
let PresentationTotalTime =0; 
/////////////////////////
let fullScreen = false;
let interval;
let maxSliderValue; //it is not runningTime since it does not change
let isPlaying=false;
let runningTime = 0; // Initialize runningTime - keep runningTime and not use sound.seek() since sound.seek() is a function where as the runningTime is a value that can be passed to the components.
// let content=[];
let notFreeContent = false;
let eqs=[];
let questionDetails;
onMount(async () => {
  try {
  // debugger;
  let  id = new URLSearchParams(location.search).get("id"); 
  const token = localStorage.getItem("token");
  const resp = await fetch( `${BASE_URL}/fe/get_question` ,{
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify( {id} )
  });
  
    if (resp.ok) {
      
        const data = await resp.json();
      
        const question  = data.question //===> important
        eqs = question.eqs;
        soundFile = await getSoundFile(question.filename);
    questionDetails = question.filename;;

    sound = new Howl({
    src: [soundFile],
    volume: 1.0,
    onload: function() {
        eqs = eqs.map( (eq)=>{eq.isf = false;return eq;});
        PresentationTotalTime = sound.duration();
        maxSliderValue = PresentationTotalTime;
        //--check again
        eqs[eqs.length-1].eqEndTime =  PresentationTotalTime;
        
    }
    });

    } else {
        const data = await resp.json();
        toast.push(data.message);
    }
  } catch (error) {
    toast.push('Unknown Error');
    // console.error(error);
  }
});
/////////////////////////////////////////
</script>

{#if !isPlaying}
<MainNav/>
{/if}

{#if notFreeContent}
<div>
This is premier content
</div>
{/if}

 <div class='p-1 m-0 text-xs bg-gray-800 text-yellow-600  '>{questionDetails}</div>

<!-- ************** -->
<div class='bg-gray-800 w-full  text-white min-h-screen p-0 m-0'>
    <Sticky {start} {stop} {runningTime} {changeSeek} maxSliderValue={maxSliderValue}/>
   

    <div class="flex px-2 rounded-md bg-gray-900" >
 
<!--Main Panel---->
{#if !fullScreen}
        <div class= "w-8/12 min-h-screen p-2  m-0 overflow-x-auto"  >
        <EqPanel {eqs}  {runningTime}  {changeSeek}/>
        </div>

<!--Side Panel---->
        <div class= "w-4/12   min-h-screen p-2 m-0 mt-2  bg-yellow-950 text-yellow-300b" >
        <SidePanel  {eqs} {runningTime} />
        </div>
{:else}
<!--Full Screen---->
        <div class= "w-full   min-h-screen p-2 m-0 mt-2  bg-yellow-950 text-yellow-300b" >
        <FullScreen eqs= {eqs} />
        </div>
{/if}
    </div><!--flex div for 2 panels-->
<br>
<br>
<br>
<br>
<br>

</div><!--page div-->
